<!DOCTYPE html>
<html lang="en">
  <head>
    <meta chatset="UTF-8">
    <meta name="viewport" content="width=device-width; initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>pandorasaga anti-cheat</title>
  </head>
  <body>
    <h3>all this to play an old game</h3>
    <h4>tl;dr qemu has flags to 3d accelerate a vm.</h4>
    <main>
      <section>
        <p> last night I spent a solid 6 hours attempting to defeat a Russian private server's anti-cheat. I understand why it's there, given the game has a history of multi-boxing. I personally don't believe multi-boxing is a harmful practice. I also know how it can be harmful if automation isn't prevented, which typically means two things: 1. emulated inputs are blocked 2. running processes are monitored there are more sophisticated ways of stopping game automation, like checking environment signatures signaled by inconsistencies in network activity. anti-cheat such as gameguard monitor the whole system from a kernel level. peripheral input and calls to graphics API or windows API functions are heavily monitored or outright blocked. for this private server, the anti-cheat is rudimentary. it checks for all input at a low level. still userland level - not kernel. it does so using keyboard hooks. my guess is SetWindowsHookEx to get all inputs as they come through RDP. inputs are sent through the protocol to the window as virtual input. if you're in a virtual machine, it's different, so I shifted to a qemu configuration to get around it. I faced roadblocks along the way that eventually lead to success. the pandora saga launcher will open in a virtual machine. the game will not start on login and will instead error out. "virtual machine detected!" </p>
      </section>
      <section>
        <p> virtual machines are easily detected as vms by the guest operating system. qemu has a flag to hide this:
          <pre>
          <code>
			    &lt;kvm&gt;&lt;hidden state="on"/&gt;&lt;/kvm&gt;
			    </code>
			    </pre>
          disable the hyperivsor cpu feature also:
          <pre>
			    <code>
		      &lt;cpu mode="host" check="none"&gt;
	        &lt;model fallback="allow"/&gt;
			    &lt;feature policy="disable" name="hypervisor"/&gt;
		      &lt;/cpu&gt;
			    </code>
			    </pre>
          task manager will no longer show "virtual machine: yes" in detailed performance view. I use an intel arc a770 so my gpu driver does not trigger anything like error 39 on nvidia cards. </p>
      </section>
      <section>
        <p> with that fixed, the next hurdle is getting keyboard input to the game. before fixing this part, I could use my mouse to navigate the game and click hotbars. I tested a few configurations of virtual machines and found key clues: 1. mouse input always worked regardless of RDP or virtual machine 2. moonlight RDP into a virtual machine directly blocked keyboard input in game 3. passing a keyboard to a windows vm gave me keyboard input 4. running the game in a basic QXL vm with no graphics drivers allowed keyboard input 5. opengl + spice 3d acceleration configs exist 6. virt-manager supports m-dev SR-IOV gpu partitions 7. my install of qemu had SDL window support but no spice, only spice-app the most important clues being 1, 3, 5, and 7. 6 lead me nowhere. intel consumer cards technically support SR-IOV. the functionality is undocumented and difficult to troubleshoot on arc cards. older igpus support it for some reason. virtio guest tools has a driver for virtio graphics from qemu. you can only have 3d acceleration with virtio graphics if you're not passing a physical device or using an m-dev partitioned gpu. dxdiag now shows "Red Hat Virtio DOD D3D Driver" or something of the sort. </p>
      </section>
      <section>
        <p> in the end, I wrote a qemu command that opens an sdl window with 3d acceleration. the opengl 3d acceleration uses the hosts gpu driver opengl by piping calls to/from qemu to the render device /dev/dri/renderd128 on the host. vram is automatically allocated up to a limit. you can't play cyberpunk 2077 this way. pandora saga is mostly cpu dependent even with vulkan translation, which I can't use anyway with opengl. directx 9 is enough for my purposes. now keyboard input is sent directly from the guest vm in the sdl window, eliminating RDP emulated inputs. the window captures my mouse and keyboard. it does not show as a virtual machine in task manager.
          <pre>
				  <code>
		      #!/bin/bash

		      QEMU_BIN="/usr/bin/qemu-system-x86_64"
		      VM_NAME="win10"
		      VM_UUID="<your own uuid>"
		      VM_MEMORY="8G"
		      VM_CPUS="4,cores=4"
	        VM_QCOW2="/var/lib/libvirt/images/win10.qcow2"
          VIRTIO_ISO="/home/mino/Downloads/virtio-win-0.1.271.iso"
		      $QEMU_BIN \
		        -name "$VM_NAME" \
		        -uuid "$VM_UUID" \
		        -enable-kvm \
		        -m "$VM_MEMORY" \
		        -smp "$VM_CPUS" \
		        -cpu host,hypervisor=off \
		        -smbios type=1,manufacturer=RedHat,product=KVM,version=9.2.0,uuid="$VM_UUID" \
		        -M pc-q35-9.2 \
		        -rtc base=localtime,driftfix=slew \
		        -device ich9-intel-hda \
		        -device hda-duplex \
		        -device intel-hda \
		        -device hda-codec-all \
		        -device virtio-balloon-pci,bus=pcie.0,addr=0x4 \
		        -device virtio-serial-pci,bus=pcie.0,addr=0x3 \
		        -device qemu-xhci,bus=pcie.0,addr=0x2 \
		        -device usb-tablet \
		        -device usb-mouse \
		        -device usb-kbd \
		        -device ich9-ahci,id=sata0,bus=pcie.0,addr=0x7 \
		        -drive file="$VM_QCOW2",if=none,format=qcow2,discard=unmap,id=disk0 \
		        -device virtio-blk-pci,drive=disk0,bus=pcie.0,addr=0x5 \
		        -drive file="$VIRTIO_ISO",media=cdrom,read-only=on,id=cdrom0 \
		        -device ide-cd,drive=cdrom0,bus=sata0.1,unit=1 \
		        -netdev user,id=vnet0 \
		        -device e1000e,netdev=vnet0,mac=52:54:00:17:a4:dd,bus=pcie.0,addr=0x6 \
		        -serial pty \
		        -monitor stdio \
		        -display sdl,gl=on \
		        -nodefaults
						</code>
						</pre>
        </p>
      </section>
    </main>
  </body>
</html>
